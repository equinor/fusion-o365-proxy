
trigger: none
pr: none

schedules:
  - cron: 0 0 1 * *
    always: true
    branches:
      include:
        - master

pool:
  vmImage: "ubuntu-latest"

variables:
  subscriptionService: 'PROJECT_PORTAL (63b791ae-b2bc-41a1-ac66-806c4e69bffe)'
  k8sSecretName: 'aad-client-secret'
  aadApplicationName: 'Fusion O365 Proxy'

jobs:
  - deployment: RotateTest
    displayName: 'Rotate client secret in test'
    #pool: Private Docker
    environment: fusion-o365-proxy.fusion-o365-proxy-test

    variables:
      k8sNamespace: fusion-o365-proxy-test
    
    strategy:
      runOnce:
        deploy:
          steps: 
          - task: Kubernetes@1
            displayName: 'Login to cluster'
            inputs:
              command: 'login'            

          - template: templates/ensure-credentials-secret.template.yml
            parameters:
              subscriptionService: $(subscriptionService)
              aadApplicationName: $(aadApplicationName)
              k8sNamespace: $(k8sNamespace)
              k8sSecretName: $(k8sSecretName)

  - deployment: RotateProd
    displayName: 'Rotate client secret in prod'
    #pool: Private Docker
    environment: fusion-o365-proxy.fusion-o365-proxy-prod

    variables:
      k8sNamespace: fusion-o365-proxy-prod
    
    strategy:
      runOnce:
        deploy:
          steps: 
          - task: Kubernetes@1
            displayName: 'Login to cluster'
            inputs:
              command: 'login'            

          - template: templates/ensure-credentials-secret.template.yml
            parameters:
              subscriptionService: $(subscriptionService)
              aadApplicationName: $(aadApplicationName)
              k8sNamespace: $(k8sNamespace)
              k8sSecretName: $(k8sSecretName)              